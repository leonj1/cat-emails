FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install -U "ell-ai[all]"

# Copy all necessary Python files
COPY gmail_fetcher.py .
COPY gmail_fetcher_service.py .
COPY domain_service.py .
COPY send_summary_report.py .
COPY send_emails.py .
COPY models/ ./models/
COPY services/ ./services/
COPY email_providers/ ./email_providers/
COPY templates/ ./templates/

# Set environment variables
ENV GMAIL_EMAIL=""
ENV HOURS="2"
ENV SCAN_INTERVAL="2"
ENV PYTHONUNBUFFERED=1
ENV ENABLE_SUMMARIES="true"
ENV SUMMARY_RECIPIENT_EMAIL=""
ENV SMTP_USERNAME=""
ENV OLLAMA_HOST_PRIMARY="10.1.1.247:11434"
ENV OLLAMA_HOST_SECONDARY="10.1.1.212:11434"
ENV DATABASE_PATH="/app/email_summaries/summaries.db"

# Email schedule configuration (24-hour format, Eastern Time)
ENV MORNING_HOUR="8"
ENV MORNING_MINUTE="0"
ENV EVENING_HOUR="20"
ENV EVENING_MINUTE="0"

# Make the service script executable
RUN chmod +x gmail_fetcher_service.py

# Health check - checks if the Python process is still running
HEALTHCHECK --interval=60s --timeout=10s --start-period=30s --retries=3 \
  CMD ps aux | grep -v grep | grep -q "python gmail_fetcher_service.py" || exit 1

# Run the service
ENTRYPOINT ["python", "gmail_fetcher_service.py"]