{% extends "base.html" %}

{% block title %}Email Accounts - Cat-Emails{% endblock %}

{% block extra_styles %}
<style>
    /* Custom styles for accounts table */
    .accounts-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .accounts-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .accounts-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .accounts-table thead th {
        padding: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        border: none;
    }

    .accounts-table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid #e5e7eb;
    }

    /* Alternating row colors for better readability */
    .accounts-table tbody tr:nth-child(odd) {
        background-color: #f9fafb;
    }

    .accounts-table tbody tr:nth-child(even) {
        background-color: #f3f4f6;
    }

    /* Hover effect */
    .accounts-table tbody tr:hover {
        background-color: #e5e7eb;
        transform: scale(1.01);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .accounts-table tbody td {
        padding: 1rem;
        vertical-align: middle;
        color: #374151;
        font-size: 0.9375rem;
    }

    /* Status badges with enhanced styling */
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8125rem;
        font-weight: 600;
        display: inline-block;
        min-width: 5rem;
        text-align: center;
    }

    .status-badge.active {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
    }

    .status-badge.inactive {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
    }

    .btn-edit {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .btn-edit:hover {
        background-color: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
    }

    .btn-delete {
        background-color: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    .btn-delete:hover {
        background-color: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
    }

    .btn-refresh {
        background-color: #8b5cf6;
        color: white;
        border-color: #8b5cf6;
    }

    .btn-refresh:hover {
        background-color: #7c3aed;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
    }

    /* Email address styling */
    .email-address {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.9375rem;
    }

    /* Display name styling */
    .display-name {
        color: #6b7280;
        font-size: 0.875rem;
        font-style: italic;
    }

    /* Last scan time styling */
    .last-scan {
        font-size: 0.875rem;
        color: #6b7280;
    }

    /* Stats cards */
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid;
        transition: transform 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card.total {
        border-left-color: #3b82f6;
    }

    .stat-card.active {
        border-left-color: #22c55e;
    }

    .stat-card.inactive {
        border-left-color: #6b7280;
    }

    .stat-card.recent {
        border-left-color: #8b5cf6;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Loading state */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        display: none;
    }

    .loading-overlay.active {
        display: flex;
    }

    /* No accounts message */
    .no-accounts {
        text-align: center;
        padding: 4rem 2rem;
        color: #6b7280;
    }

    .no-accounts i {
        font-size: 4rem;
        color: #d1d5db;
        margin-bottom: 1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .accounts-table {
            font-size: 0.875rem;
        }

        .accounts-table thead {
            display: none;
        }

        .accounts-table tbody tr {
            display: block;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .accounts-table tbody td {
            display: block;
            text-align: right;
            padding: 0.75rem 1rem;
            position: relative;
            padding-left: 50%;
        }

        .accounts-table tbody td:before {
            content: attr(data-label);
            position: absolute;
            left: 1rem;
            font-weight: 600;
            text-align: left;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="accounts-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="bi bi-person-lines-fill me-3"></i>
                    Email Accounts Management
                </h1>
                <p class="mb-0 opacity-75">
                    Configure and manage email accounts for automated processing
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <button class="btn btn-light btn-lg" onclick="refreshAccounts()">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    Refresh
                </button>
                <button class="btn btn-success btn-lg ms-2" onclick="addAccount()">
                    <i class="bi bi-plus-circle me-2"></i>
                    Add Account
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="stats-cards">
        <div class="stat-card total">
            <div class="stat-value" id="total-accounts">0</div>
            <div class="stat-label">Total Accounts</div>
        </div>
        <div class="stat-card active">
            <div class="stat-value" id="active-accounts">0</div>
            <div class="stat-label">Active Accounts</div>
        </div>
        <div class="stat-card inactive">
            <div class="stat-value" id="inactive-accounts">0</div>
            <div class="stat-label">Inactive Accounts</div>
        </div>
        <div class="stat-card recent">
            <div class="stat-value" id="recent-scans">0</div>
            <div class="stat-label">Scanned Today</div>
        </div>
    </div>

    <!-- Accounts Table -->
    <div class="accounts-table">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Email Address</th>
                    <th>Display Name</th>
                    <th>Status</th>
                    <th>Last Scan</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="accounts-tbody">
                <!-- Table rows will be populated dynamically -->
            </tbody>
        </table>
    </div>

    <!-- No Accounts Message -->
    <div id="no-accounts-message" class="no-accounts" style="display: none;">
        <i class="bi bi-inbox"></i>
        <h3>No Email Accounts Configured</h3>
        <p>Click the "Add Account" button above to configure your first email account.</p>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5>Loading accounts...</h5>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this email account?</p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    This action cannot be undone and will remove all associated data.
                </p>
                <p class="fw-bold" id="delete-account-email"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash me-2"></i>Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2"></i>
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            <!-- Message will be inserted here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let accountsData = [];
    let accountToDelete = null;

    // HTML escaping function to prevent XSS
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadAccounts();
    });

    // Load accounts from API
    async function loadAccounts() {
        showLoading();

        try {
            const response = await fetch('/api/accounts');
            const data = await response.json();

            if (data.success && data.accounts) {
                accountsData = data.accounts;
                updateStatistics();
                renderAccountsTable();
            } else {
                showToast('Failed to load accounts', 'error');
            }
        } catch (error) {
            console.error('Error loading accounts:', error);
            showToast('Error loading accounts: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // Update statistics cards
    function updateStatistics() {
        const total = accountsData.length;
        const active = accountsData.filter(a => a.is_active).length;
        const inactive = total - active;

        // Calculate accounts scanned today
        const today = new Date();
        today.setUTCHours(0, 0, 0, 0);
        const recent = accountsData.filter(a => {
            if (!a.last_scan_at) return false;
            const scanDate = new Date(a.last_scan_at);
            scanDate.setUTCHours(0, 0, 0, 0);
            return scanDate.getTime() >= today.getTime();
        }).length;

        document.getElementById('total-accounts').textContent = total;
        document.getElementById('active-accounts').textContent = active;
        document.getElementById('inactive-accounts').textContent = inactive;
        document.getElementById('recent-scans').textContent = recent;
    }

    // Render accounts table
    function renderAccountsTable() {
        const tbody = document.getElementById('accounts-tbody');
        const noAccountsMessage = document.getElementById('no-accounts-message');
        const table = document.querySelector('.accounts-table');

        if (accountsData.length === 0) {
            table.style.display = 'none';
            noAccountsMessage.style.display = 'block';
            return;
        }

        table.style.display = 'block';
        noAccountsMessage.style.display = 'none';

        tbody.innerHTML = '';

        accountsData.forEach(account => {
            const row = document.createElement('tr');

            // Format last scan time
            let lastScan = 'Never';
            if (account.last_scan_at) {
                const scanDate = new Date(account.last_scan_at);
                lastScan = formatRelativeTime(scanDate);
            }

            // Format created date
            let created = '--';
            if (account.created_at) {
                const createdDate = new Date(account.created_at);
                created = createdDate.toLocaleDateString();
            }

            // Status badge
            const statusBadge = account.is_active
                ? '<span class="status-badge active">Active</span>'
                : '<span class="status-badge inactive">Inactive</span>';

            // Display name (escape to prevent XSS)
            const displayName = account.display_name
                ? escapeHtml(account.display_name)
                : '<span class="display-name">No display name</span>';

            // Escape email address for safe use in HTML and onclick handlers
            const escapedEmail = escapeHtml(account.email_address);
            const emailForJs = account.email_address.replace(/'/g, "\\'").replace(/"/g, '\\"');

            row.innerHTML = `
                <td data-label="Email Address">
                    <span class="email-address">${escapedEmail}</span>
                </td>
                <td data-label="Display Name">${displayName}</td>
                <td data-label="Status">${statusBadge}</td>
                <td data-label="Last Scan">
                    <span class="last-scan">${lastScan}</span>
                </td>
                <td data-label="Created">${created}</td>
                <td data-label="Actions">
                    <div class="action-buttons">
                        <button class="btn-action btn-edit" onclick="editAccount('${emailForJs}')" title="Edit Account">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-action btn-refresh" onclick="scanAccount('${emailForJs}')" title="Scan Now">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteAccount('${emailForJs}')" title="Delete Account">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    // Format relative time
    function formatRelativeTime(date) {
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) {
            return `${days} day${days > 1 ? 's' : ''} ago`;
        } else if (hours > 0) {
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        } else if (minutes > 0) {
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else {
            return 'Just now';
        }
    }

    // Refresh accounts
    function refreshAccounts() {
        showToast('Refreshing accounts...', 'info');
        loadAccounts();
    }

    // Add account (placeholder)
    function addAccount() {
        showToast('Add account feature coming soon!', 'info');
    }

    // Edit account (placeholder)
    function editAccount(email) {
        showToast(`Edit feature for ${email} coming soon!`, 'info');
    }

    // Scan account now (placeholder)
    function scanAccount(email) {
        showToast(`Initiating scan for ${email}...`, 'info');
    }

    // Delete account
    function deleteAccount(email) {
        accountToDelete = email;
        document.getElementById('delete-account-email').textContent = email;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    // Confirm deletion
    async function confirmDelete() {
        if (!accountToDelete) return;

        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();

        showLoading();

        try {
            const response = await fetch(`/api/accounts/${accountToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (response.ok) {
                showToast(`Account ${accountToDelete} deleted successfully`, 'success');
                accountToDelete = null;
                // Reload accounts
                await loadAccounts();
            } else {
                showToast(data.detail || 'Failed to delete account', 'error');
            }
        } catch (error) {
            console.error('Error deleting account:', error);
            showToast('Error deleting account: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // Show loading overlay
    function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
    }

    // Hide loading overlay
    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const toastEl = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastHeader = toastEl.querySelector('.toast-header');

        // Update message
        toastMessage.textContent = message;

        // Update styling based on type
        toastHeader.className = 'toast-header';
        const icon = toastHeader.querySelector('i');

        if (type === 'success') {
            toastHeader.classList.add('bg-success', 'text-white');
            icon.className = 'bi bi-check-circle me-2';
        } else if (type === 'error') {
            toastHeader.classList.add('bg-danger', 'text-white');
            icon.className = 'bi bi-exclamation-circle me-2';
        } else if (type === 'warning') {
            toastHeader.classList.add('bg-warning');
            icon.className = 'bi bi-exclamation-triangle me-2';
        } else {
            toastHeader.classList.add('bg-info', 'text-white');
            icon.className = 'bi bi-info-circle me-2';
        }

        // Show toast
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadAccounts();
    }, 30000);
</script>
{% endblock %}