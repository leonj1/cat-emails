{% extends "base.html" %}

{% block title %}Dashboard - Cat-Emails{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header mb-4">
    <div class="row align-items-center">
        <div class="col-12 col-lg-8">
            <div class="welcome-section">
                <h1 class="display-6 fw-bold text-primary mb-2">
                    <i class="bi bi-envelope-check-fill me-3"></i>
                    Cat-Emails Dashboard
                </h1>
                <p class="lead text-muted mb-0">AI-powered email categorization analytics and insights</p>
                <p class="text-muted small mb-0">
                    <i class="bi bi-clock me-1"></i>
                    <span id="dashboard-last-updated">Loading...</span>
                </p>
            </div>
        </div>
        <div class="col-12 col-lg-4 mt-3 mt-lg-0">
            <div class="controls-section">
                <div class="card border-0 bg-light">
                    <div class="card-body p-3">
                        <label class="form-label small fw-semibold text-uppercase text-muted mb-2">
                            Time Period
                        </label>
                        <div class="btn-group w-100" role="group" aria-label="Time period selector">
                            <input type="radio" class="btn-check" name="period" id="period-day" value="day">
                            <label class="btn btn-outline-primary btn-sm flex-fill" for="period-day">
                                <i class="bi bi-calendar-day me-1"></i>Day
                            </label>

                            <input type="radio" class="btn-check" name="period" id="period-week" value="week" checked>
                            <label class="btn btn-outline-primary btn-sm flex-fill" for="period-week">
                                <i class="bi bi-calendar-week me-1"></i>Week
                            </label>

                            <input type="radio" class="btn-check" name="period" id="period-month" value="month">
                            <label class="btn btn-outline-primary btn-sm flex-fill" for="period-month">
                                <i class="bi bi-calendar-month me-1"></i>Month
                            </label>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="refreshDashboardData()" title="Refresh dashboard data">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Overview -->
<div class="metrics-overview mb-4">
    <div class="row g-3">
        <!-- Total Processed Metric -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="metric-card card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="metric-icon bg-primary bg-opacity-10 rounded-3 p-2">
                            <i class="bi bi-envelope-check text-primary fs-4"></i>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success-subtle text-success small" id="processed-trend">--</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value text-primary mb-1" id="total-processed">--</h3>
                        <p class="metric-label text-muted small mb-0">Emails Processed</p>
                        <p class="metric-subtitle text-muted small" id="processed-subtitle">--</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Categorized Metric -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="metric-card card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="metric-icon bg-success bg-opacity-10 rounded-3 p-2">
                            <i class="bi bi-tags text-success fs-4"></i>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-info-subtle text-info small" id="categories-count-badge">--</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value text-success mb-1" id="active-categories">--</h3>
                        <p class="metric-label text-muted small mb-0">Active Categories</p>
                        <p class="metric-subtitle text-muted small" id="categories-subtitle">--</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Processing Rate -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="metric-card card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="metric-icon bg-info bg-opacity-10 rounded-3 p-2">
                            <i class="bi bi-speedometer2 text-info fs-4"></i>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary-subtle text-primary small" id="processing-efficiency">--</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value text-info mb-1" id="avg-processing">--</h3>
                        <p class="metric-label text-muted small mb-0">Avg. Processing Time</p>
                        <p class="metric-subtitle text-muted small" id="processing-subtitle">per email</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Rate -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="metric-card card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="metric-icon bg-warning bg-opacity-10 rounded-3 p-2">
                            <i class="bi bi-shield-check text-warning fs-4"></i>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-warning-subtle text-warning small" id="deletion-rate">--%</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value text-warning mb-1" id="total-deleted">--</h3>
                        <p class="metric-label text-muted small mb-0">Filtered Out</p>
                        <p class="metric-subtitle text-muted small">deleted or archived</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TOP 25 CATEGORIES - MAIN FOCUS SECTION -->
<div class="main-categories-section mb-4">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient border-0 py-3">
                    <div class="row align-items-center">
                        <div class="col-12 col-md-8">
                            <h2 class="card-title mb-0 fw-bold text-primary">
                                <i class="bi bi-trophy-fill me-3 text-warning"></i>
                                Top 25 Email Categories
                            </h2>
                            <p class="text-muted small mb-0 mt-1">Most common email categories from your inbox analysis</p>
                        </div>
                        <div class="col-12 col-md-4 mt-2 mt-md-0 text-md-end">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Display options">
                                <input type="radio" class="btn-check" name="categories-view" id="view-combined" value="combined" checked>
                                <label class="btn btn-outline-primary" for="view-combined">
                                    <i class="bi bi-layout-sidebar me-1"></i>Combined
                                </label>
                                
                                <input type="radio" class="btn-check" name="categories-view" id="view-chart" value="chart">
                                <label class="btn btn-outline-primary" for="view-chart">
                                    <i class="bi bi-pie-chart me-1"></i>Chart
                                </label>
                                
                                <input type="radio" class="btn-check" name="categories-view" id="view-list" value="list">
                                <label class="btn btn-outline-primary" for="view-list">
                                    <i class="bi bi-list-ol me-1"></i>List
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Combined View (Default) -->
                    <div id="categories-combined-view" class="categories-view">
                        <div class="row g-0">
                            <!-- Chart Section -->
                            <div class="col-12 col-lg-7 border-end">
                                <div class="p-4">
                                    <div class="chart-header mb-3">
                                        <h5 class="fw-semibold text-secondary mb-1">
                                            <i class="bi bi-pie-chart-fill me-2"></i>
                                            Category Distribution
                                        </h5>
                                        <p class="text-muted small mb-0">Visual breakdown of your top categories</p>
                                    </div>
                                    <div class="chart-container position-relative" style="height: 400px;">
                                        <canvas id="categories-chart" class="w-100 h-100"></canvas>
                                        <div id="chart-loading" class="position-absolute top-50 start-50 translate-middle text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading chart...</span>
                                            </div>
                                            <p class="mt-2 text-muted small">Loading chart data...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Top 25 List Section -->
                            <div class="col-12 col-lg-5">
                                <div class="p-4">
                                    <div class="list-header mb-3">
                                        <h5 class="fw-semibold text-secondary mb-1">
                                            <i class="bi bi-list-ol me-2"></i>
                                            Top 25 Rankings
                                        </h5>
                                        <p class="text-muted small mb-0">Detailed category breakdown with counts</p>
                                    </div>
                                    <div class="categories-list-container" style="max-height: 400px; overflow-y: auto;">
                                        <div id="categories-list" class="list-group list-group-flush">
                                            <div class="text-center py-5">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading categories...</span>
                                                </div>
                                                <p class="mt-3 text-muted">Loading top 25 categories...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart-Only View -->
                    <div id="categories-chart-view" class="categories-view d-none">
                        <div class="p-4">
                            <div class="chart-container" style="height: 500px;">
                                <canvas id="categories-chart-full" class="w-100 h-100"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- List-Only View -->
                    <div id="categories-list-view" class="categories-view d-none">
                        <div class="p-4">
                            <div class="row">
                                <div class="col-12 col-md-6 col-lg-4 mb-3" id="categories-col-1"></div>
                                <div class="col-12 col-md-6 col-lg-4 mb-3" id="categories-col-2"></div>
                                <div class="col-12 col-md-12 col-lg-4 mb-3" id="categories-col-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Analytics Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <ul class="nav nav-tabs card-header-tabs" id="analytics-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="senders-tab" data-bs-toggle="tab" data-bs-target="#senders" type="button" role="tab" aria-controls="senders" aria-selected="true">
                            <i class="bi bi-person me-2"></i>Top Senders
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="domains-tab" data-bs-toggle="tab" data-bs-target="#domains" type="button" role="tab" aria-controls="domains" aria-selected="false">
                            <i class="bi bi-globe me-2"></i>Top Domains
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab" aria-controls="trends" aria-selected="false">
                            <i class="bi bi-graph-up me-2"></i>Historical Trends
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab" aria-controls="performance" aria-selected="false">
                            <i class="bi bi-speedometer2 me-2"></i>Performance
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content" id="analytics-tab-content">
                    <!-- Senders Tab -->
                    <div class="tab-pane fade show active" id="senders" role="tabpanel" aria-labelledby="senders-tab">
                        <div class="row">
                            <div class="col-12 col-lg-8">
                                <h5 class="mb-3">
                                    <i class="bi bi-bar-chart me-2"></i>
                                    Top Senders
                                </h5>
                                <div class="chart-container">
                                    <canvas id="senders-chart" width="400" height="300"></canvas>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-envelope-at me-2"></i>
                                    Sender Details
                                </h5>
                                <div id="senders-list" class="list-group list-group-flush">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading senders...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Domains Tab -->
                    <div class="tab-pane fade" id="domains" role="tabpanel" aria-labelledby="domains-tab">
                        <div class="row">
                            <div class="col-12 col-lg-8">
                                <h5 class="mb-3">
                                    <i class="bi bi-diagram-3 me-2"></i>
                                    Top Domains
                                </h5>
                                <div class="chart-container">
                                    <canvas id="domains-chart" width="400" height="300"></canvas>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-shield-check me-2"></i>
                                    Domain Status
                                </h5>
                                <div id="domains-list" class="list-group list-group-flush">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading domains...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trends Tab -->
                    <div class="tab-pane fade" id="trends" role="tabpanel" aria-labelledby="trends-tab">
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                                    <div class="mb-2 mb-md-0">
                                        <h5 class="mb-1">
                                            <i class="bi bi-graph-up-arrow me-2 text-primary"></i>
                                            Historical Category Trends
                                        </h5>
                                        <p class="text-muted small mb-0">Track email category patterns over time</p>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group" aria-label="Trends period">
                                        <input type="radio" class="btn-check" name="trends-period" id="trends-7" value="7">
                                        <label class="btn btn-outline-primary" for="trends-7">
                                            <i class="bi bi-calendar-week me-1"></i>7 Days
                                        </label>

                                        <input type="radio" class="btn-check" name="trends-period" id="trends-30" value="30" checked>
                                        <label class="btn btn-outline-primary" for="trends-30">
                                            <i class="bi bi-calendar-month me-1"></i>30 Days
                                        </label>

                                        <input type="radio" class="btn-check" name="trends-period" id="trends-90" value="90">
                                        <label class="btn btn-outline-primary" for="trends-90">
                                            <i class="bi bi-calendar-range me-1"></i>90 Days
                                        </label>
                                    </div>
                                </div>
                                <div class="chart-container bg-white rounded border" style="height: 450px;">
                                    <canvas id="trends-chart" class="w-100 h-100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Tab -->
                    <div class="tab-pane fade" id="performance" role="tabpanel" aria-labelledby="performance-tab">
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h5 class="mb-1">
                                            <i class="bi bi-speedometer2 me-2 text-info"></i>
                                            System Performance Metrics
                                        </h5>
                                        <p class="text-muted small mb-0">Processing efficiency and system health</p>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshProcessingRuns()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
                                    </button>
                                </div>
                                
                                <!-- Performance Summary Cards -->
                                <div class="row mb-4">
                                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="bi bi-clock-history text-info fs-3 mb-2"></i>
                                                <h6 class="text-muted small mb-1">Avg Run Duration</h6>
                                                <h4 class="text-info mb-0" id="avg-run-duration">--</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="bi bi-check-circle text-success fs-3 mb-2"></i>
                                                <h6 class="text-muted small mb-1">Success Rate</h6>
                                                <h4 class="text-success mb-0" id="success-rate">--%</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="bi bi-envelope text-primary fs-3 mb-2"></i>
                                                <h6 class="text-muted small mb-1">Emails/Run</h6>
                                                <h4 class="text-primary mb-0" id="avg-emails-run">--</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="bi bi-lightning text-warning fs-3 mb-2"></i>
                                                <h6 class="text-muted small mb-1">Processing Rate</h6>
                                                <h4 class="text-warning mb-0" id="processing-rate">-- emails/s</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                                <!-- Recent Processing Runs Table -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card border-0 bg-white">
                                            <div class="card-header bg-transparent border-bottom">
                                                <h6 class="mb-0 text-secondary">
                                                    <i class="bi bi-list-task me-2"></i>
                                                    Recent Processing Runs
                                                </h6>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover table-sm mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th class="px-3 py-2">Run ID</th>
                                                                <th class="px-3 py-2">Started</th>
                                                                <th class="px-3 py-2">Duration</th>
                                                                <th class="px-3 py-2">Processed</th>
                                                                <th class="px-3 py-2">Filtered</th>
                                                                <th class="px-3 py-2">Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="processing-runs-table">
                                                            <tr>
                                                                <td colspan="6" class="text-center py-4">
                                                                    <div class="spinner-border text-primary spinner-border-sm" role="status">
                                                                        <span class="visually-hidden">Loading...</span>
                                                                    </div>
                                                                    <p class="mt-2 text-muted small mb-0">Loading recent runs...</p>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Dashboard initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize dashboard
        initializeDashboard();
        
        // Set up period selector event listeners
        document.querySelectorAll('input[name="period"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    refreshDashboardData(this.value);
                }
            });
        });
        
        // Set up categories view switcher
        document.querySelectorAll('input[name="categories-view"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    switchCategoriesView(this.value);
                }
            });
        });
        
        // Set up trends period selector
        document.querySelectorAll('input[name="trends-period"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    refreshTrendsData(parseInt(this.value));
                }
            });
        });
        
        // Set up analytics tab change listeners
        document.querySelectorAll('#analytics-tabs button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (event) {
                const targetId = event.target.getAttribute('data-bs-target');
                handleAnalyticsTabSwitch(targetId);
            });
        });
        
        // Initial data load
        refreshDashboardData('week');
    });

    // Category view switching function
    function switchCategoriesView(view) {
        const views = ['combined', 'chart', 'list'];
        
        views.forEach(v => {
            const element = document.getElementById(`categories-${v}-view`);
            if (element) {
                if (v === view) {
                    element.classList.remove('d-none');
                } else {
                    element.classList.add('d-none');
                }
            }
        });
        
        // Refresh charts if switching to chart view
        if (view === 'chart' || view === 'combined') {
            setTimeout(() => {
                if (window.categoriesData) {
                    renderCategoriesChart(window.categoriesData, view === 'chart' ? 'categories-chart-full' : 'categories-chart');
                }
            }, 100);
        }
        
        // Refresh list layout if switching to list view
        if (view === 'list') {
            setTimeout(() => {
                if (window.categoriesData) {
                    renderCategoriesColumns(window.categoriesData);
                }
            }, 100);
        }
    }

    // Handle analytics tab switching (renamed from handleTabSwitch)
    function handleAnalyticsTabSwitch(targetId) {
        console.log(`Switching to analytics tab: ${targetId}`);
        
        switch (targetId) {
            case '#senders':
                refreshSendersData();
                break;
            case '#domains':
                refreshDomainsData();
                break;
            case '#trends':
                refreshTrendsData(30);
                break;
            case '#performance':
                refreshPerformanceData();
                break;
        }
    }
    
    // New function to refresh performance data
    function refreshPerformanceData() {
        // This will be implemented in the dashboard.js file
        if (typeof refreshProcessingRuns === 'function') {
            refreshProcessingRuns();
        }
    }
</script>
{% endblock %}